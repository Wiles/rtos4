<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>RTOS 4: milestone4/service.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.2 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<h1>milestone4/service.c File Reference</h1>  </div>
</div>
<div class="contents">

<p>This file will implement support for OS service calling. According to requirements, we must support Basic Atari System Services (BASS) as well as Graphical Atari System Services (GASS).  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="_r_t_o_s4_2shared_8h_source.html">shared.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="_r_t_o_s4_2rtos_8h_source.html">rtos.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="_r_t_o_s4_2globals_8h_source.html">globals.h</a>&quot;</code><br/>

<p><a href="service_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="service_8c.html#a0d5a5c85d3a2fe165bdc6754223a2a71">SupportBASS</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Service call handler for RTOS.  <a href="#a0d5a5c85d3a2fe165bdc6754223a2a71"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>This file will implement support for OS service calling. According to requirements, we must support Basic Atari System Services (BASS) as well as Graphical Atari System Services (GASS). </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Samuel Lewis, Adrian Hyde, Dan Evans, Hekar Khani </dd></dl>
<dl class="remark"><dt><b>Remarks:</b></dt><dd>As of now this file does the tasks defined for group 1 of the RTOS project. These include:</dd></dl>
<dl class="author"><dt><b>Author:</b></dt><dd>Samuel Lewis, Adrian Hyde, Dan Evans, Hekar Khani </dd></dl>
<dl class="remark"><dt><b>Remarks:</b></dt><dd>This file performs the tasks defined for group 1 of the RTOS project. Only the tasks that were feasible to do under Windows simulation were done here. Others did not make much sense under Windows, so we choose Visual 68k simulation instead. Functions included here: short <a class="el" href="_r_t_o_s4_2stdlib_8h.html#a7817d415402167748e83272c1f9056b1" title="Give up the CPU for a single re-scheduling.">InputKeyboardCharacter(void)</a>; int <a class="el" href="_r_t_o_s4_2stdlib_8h.html#a5e86c2803e6b856e239ab5f7e7e42183" title="Check if there is a keyboard character available in the system&#39;s keyboard buffer.">IsKeyboardCharacterAvailable(void)</a>; short <a class="el" href="_r_t_o_s4_2stdlib_8h.html#a7f996077ec6e319cfa3cc4aea7444e49" title="Get the next available character from the system&#39;s debugging buffer.">InputDebugCharacter(void)</a>; int <a class="el" href="_r_t_o_s4_2stdlib_8h.html#adc30e35cf9c24349d058bed13d3fafab" title="Check if there is a character available in the system&#39;s debugging buffer.">IsDebugCharacterAvailable(void)</a>; void OutputDebugCharacter (short character); int <a class="el" href="_r_t_o_s4_2stdlib_8h.html#a88f98ad2951b7add4ad75f1464076d79" title="Check if system&#39;s debugging device port is busy.">IsDebugPortBusy(void)</a>; unsigned long <a class="el" href="_r_t_o_s4_2stdlib_8h.html#a29c77b2e37f549ed666615108111956e" title="Returns the system tick count.">GetSystemTickCount(void)</a>; </dd></dl>

<p>Definition in file <a class="el" href="service_8c_source.html">service.c</a>.</p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a0d5a5c85d3a2fe165bdc6754223a2a71"></a><!-- doxytag: member="service.c::SupportBASS" ref="a0d5a5c85d3a2fe165bdc6754223a2a71" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void SupportBASS </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname">&#160;)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Service call handler for RTOS. </p>
<dl class="remark"><dt><b>Remarks:</b></dt><dd>This function implements service call support for the basic services. It will mark whether a reschedule of a new task is necessary in terms of supporting the request. </dd></dl>

<p>Definition at line <a class="el" href="service_8c_source.html#l00025">25</a> of file <a class="el" href="service_8c_source.html">service.c</a>.</p>
<div class="fragment"><pre class="fragment">{
   <span class="comment">/* Initialize our variables */</span>
   <a class="code" href="structpdb.html">PDB</a> *p;
   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *ptrUSP;
   <span class="keywordtype">int</span> fSchedule;
   <span class="keyword">struct </span><a class="code" href="structsystemtime.html" title="holds time information used by GetClockTime() service">systemtime</a> *pTime;
   <span class="keywordtype">short</span> character;


   <span class="comment">/* force re-scheduling */</span>
   fSchedule = <a class="code" href="milestone4_2shared_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;

   <span class="comment">/*</span>
<span class="comment">    * since service params on user stack,</span>
<span class="comment">    * obtain a pointer to the data on the stack, which will</span>
<span class="comment">    * be one long integer higher than current USP value,</span>
<span class="comment">    * as there&#39;s a return address for the standard library</span>
<span class="comment">    * support wrapper function call. To keep the interface</span>
<span class="comment">    * trivial, we&#39;ll assume that all service calls supply</span>
<span class="comment">    * 32 bit values to the OS.</span>
<span class="comment">    */</span>

   ptrUSP = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)(<a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a2c0e327eab0df8b992ff2a4907f8ba59">RegSP</a> + sizeof (<span class="keywordtype">long</span>));

   <span class="keywordflow">switch</span> (<a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a263bc58313bedcf0393ac2f29c2a17c4">RegD0</a>) {
   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#ae99227784bfbd8190c04c1d7bb02ee70" title="Relenquish cpu to another task.">BASS_RELINQUISH</a>:
      fSchedule = <a class="code" href="milestone4_2shared_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
      <span class="keywordflow">break</span>;

   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#ab8eab95e088c87138dc8d481fe6e4de6" title="Sleep for provided number of seconds.">BASS_SLEEP</a>:
      <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a0370837c3d36be2ec1076a19abb2239f">SleepDuration</a> = ptrUSP[0];
      <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#aff97a87345038b6d69b0a6de1f6efdf5">Status</a> = <a class="code" href="milestone4_2rtos_8h.html#a48f6457243719e7031768d4100741159">BLOCKED</a>;
      <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#adfb03271058360f2433c7ac6837ffc57">Reason</a> = <a class="code" href="milestone4_2rtos_8h.html#ac2692565e36789f1a2d3767301bf21ca">REASON_SLEEP</a>;
      fSchedule = <a class="code" href="milestone4_2shared_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
      <span class="keywordflow">break</span>;
      
   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#af279c8baecd496dfcd02608e4fe5e56b" title="get a keyboard character">BASS_GET_KEYBOARD</a>:
      <span class="keywordflow">if</span>( <a class="code" href="globals_8c.html#a725e2b350bbcfdce56aadcf50020bd2a">keyboard_head</a> != <a class="code" href="globals_8c.html#a04b002df1014220cd0a9775b8da0b698">keyboard_tail</a>)
      {
         <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a263bc58313bedcf0393ac2f29c2a17c4">RegD0</a> = <a class="code" href="globals_8c.html#af55ddd969371f06ef9222afa9be50dae">keyboard_data</a>[<a class="code" href="globals_8c.html#a04b002df1014220cd0a9775b8da0b698">keyboard_tail</a>];
         ++<a class="code" href="globals_8c.html#a04b002df1014220cd0a9775b8da0b698">keyboard_tail</a>;
      }
      <span class="keywordflow">else</span>
      {
         <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#aff97a87345038b6d69b0a6de1f6efdf5">Status</a> = <a class="code" href="milestone4_2rtos_8h.html#a48f6457243719e7031768d4100741159">BLOCKED</a>;
         <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#adfb03271058360f2433c7ac6837ffc57">Reason</a> = <a class="code" href="milestone4_2rtos_8h.html#a9e7bb35fde7e13390d80b79c41bd993e" title="Waiting for keyboard input.">REASON_KEYBOARD</a>;
         fSchedule = <a class="code" href="milestone4_2shared_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
      }
      <span class="keywordflow">break</span>;
      
   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#ae14773cfeead61b25c727a080d22e0cf" title="Is there available information in keyboard buffer.">BASS_KEYBOARD_STATUS</a>:
      <span class="keywordflow">if</span>( <a class="code" href="globals_8c.html#a725e2b350bbcfdce56aadcf50020bd2a">keyboard_head</a> != <a class="code" href="globals_8c.html#a04b002df1014220cd0a9775b8da0b698">keyboard_tail</a> )
      {
         <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a263bc58313bedcf0393ac2f29c2a17c4">RegD0</a> = <a class="code" href="milestone4_2shared_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
      }
      <span class="keywordflow">else</span>
      {
         <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a263bc58313bedcf0393ac2f29c2a17c4">RegD0</a> = <a class="code" href="milestone4_2shared_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
      }
      <span class="keywordflow">break</span>;
      
   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#abbf837c376e140625a5272884e0bb1ff" title="get a debug character">BASS_GET_DEBUG</a>:
      <span class="keywordflow">if</span>( <a class="code" href="globals_8c.html#a81c48d65c560b905241af82a7189f7e0">serial_in_head</a> != <a class="code" href="globals_8c.html#a4233c803dbb375f15303bade9f15c6e3">serial_in_tail</a> )
      {
         <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a263bc58313bedcf0393ac2f29c2a17c4">RegD0</a> = <a class="code" href="globals_8c.html#a9d355c13b2e81db96bfb18806613c2ad">serial_in_data</a>[<a class="code" href="globals_8c.html#a4233c803dbb375f15303bade9f15c6e3">serial_in_tail</a>];
         ++<a class="code" href="globals_8c.html#a4233c803dbb375f15303bade9f15c6e3">serial_in_tail</a>;
      }
      <span class="keywordflow">else</span>
      {
         <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#aff97a87345038b6d69b0a6de1f6efdf5">Status</a> = <a class="code" href="milestone4_2rtos_8h.html#a48f6457243719e7031768d4100741159">BLOCKED</a>;
         <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#adfb03271058360f2433c7ac6837ffc57">Reason</a> = <a class="code" href="milestone4_2rtos_8h.html#ab558d9e96d9c376d4e424777e57b7b6f" title="Waiting for debug input.">REASON_DEBUG_IN</a>;
         fSchedule = <a class="code" href="milestone4_2shared_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
      }
      <span class="keywordflow">break</span>;
      
   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#a954486d744000a965ef923549652837c" title="Is there available information in debug buffer.">BASS_DEBUG_IN_STATUS</a>:
      <span class="keywordflow">if</span>( <a class="code" href="globals_8c.html#a81c48d65c560b905241af82a7189f7e0">serial_in_head</a> != <a class="code" href="globals_8c.html#a4233c803dbb375f15303bade9f15c6e3">serial_in_tail</a> )
      {
         <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a263bc58313bedcf0393ac2f29c2a17c4">RegD0</a> = <a class="code" href="milestone4_2shared_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
      }
      <span class="keywordflow">else</span>
      {
         <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a263bc58313bedcf0393ac2f29c2a17c4">RegD0</a> = <a class="code" href="milestone4_2shared_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
      }
      <span class="keywordflow">break</span>;
      
   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#a5d4124f9fde89da826594b50d6936520" title="write provided character to debug port D1 - Character to write">BASS_WRITE_DEBUG</a>:
      <span class="comment">/*Write out to debug port*/</span>
      <span class="keywordflow">break</span>;
   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#a341476a01c0a3dd4026bfb2bd0a04e68" title="is the debug port busy">BASS_DEBUG_BUSY</a>:
      <span class="comment">/*Write out to debug port*/</span>
      <span class="keywordflow">break</span>;
   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#a85cc2698cb5473ccfb1f60267756faf7" title="retreive system tick count">BASS_TICK_COUNT</a>:
      <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a263bc58313bedcf0393ac2f29c2a17c4">RegD0</a> = <a class="code" href="globals_8c.html#a5092bbc9e04487b450e965e9ac6d9bec">gTickCount</a>;
      <span class="keywordflow">break</span>;
   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#ae673e4c37953fa5d3045803fa69f30c4" title="retrieve task global memory address">BASS_GLOBAL_ADDRESS</a>:
      <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a263bc58313bedcf0393ac2f29c2a17c4">RegD0</a> = <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a7dbee8d9a732f20d7b1ea3c478a41604" title="Location of tasks globabl space.">PointerToGlobalSpace</a>;
      <span class="keywordflow">break</span>;
   <span class="keywordflow">case</span> <a class="code" href="milestone4_2shared_8h.html#a715320d9656c64c2f6a452dbcddbceb7" title="get tick count formated into time A1 - Time struct">BASS_GETCLOCKTIME</a>:
      <span class="comment">/* grab the service parameters from the stack */</span>
      pTime = (<span class="keyword">struct </span><a class="code" href="structsystemtime.html" title="holds time information used by GetClockTime() service">systemtime</a> *) ptrUSP[0];
      
      <span class="comment">/*Convert tickcount to time*/</span>
      pTime-&gt;<a class="code" href="structsystemtime.html#ab63ea933fbb79f50e51e1959aa067b36">hour</a> = <a class="code" href="globals_8c.html#a5092bbc9e04487b450e965e9ac6d9bec">gTickCount</a> / 3600;
      pTime-&gt;minutes = ( <a class="code" href="globals_8c.html#a5092bbc9e04487b450e965e9ac6d9bec">gTickCount</a> - (pTime-&gt;<a class="code" href="structsystemtime.html#ab63ea933fbb79f50e51e1959aa067b36">hour</a> * 3600) ) / 60; 
      pTime-&gt;<a class="code" href="structsystemtime.html#aa77fc58284b8ee8ca387c1eebce38b75">second</a> = <a class="code" href="globals_8c.html#a5092bbc9e04487b450e965e9ac6d9bec">gTickCount</a> % 60;
      <span class="keywordflow">break</span>;
   <span class="keywordflow">default</span>:
      <a class="code" href="globals_8c.html#a4aeadd3243fdca95786dd95dc58fa4e7">pdb_Current</a>-&gt;<a class="code" href="structpdb.html#a263bc58313bedcf0393ac2f29c2a17c4">RegD0</a> = <a class="code" href="milestone4_2rtos_8h.html#a8fe83ac76edc595f6b98cd4a4127aed5">ERROR</a>;
      <span class="keywordflow">break</span>;
   }  <span class="comment">/* end switch */</span>

   <span class="comment">/*</span>
<span class="comment">    * if required, schedule a new task to run</span>
<span class="comment">    */</span>

   <span class="keywordflow">if</span> (fSchedule)
      <a class="code" href="milestone4_2rtos_8h.html#a26c5af6bb9bd7e1b4acc69cc24d3846f" title="Robin round scheduler.">RoundRobinScheduler</a>();

}  <span class="comment">/* end SupportBASS */</span>
</pre></div>
</div>
</div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Wed Dec 15 2010 09:49:12 for RTOS 4 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
